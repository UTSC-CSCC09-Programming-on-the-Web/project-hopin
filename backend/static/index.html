<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User API Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      h1 {
        color: #333;
      }
      .section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      form {
        display: flex;
        flex-direction: column;
      }
      label {
        margin-top: 10px;
      }
      input,
      button {
        margin-top: 5px;
        padding: 8px;
      }
      button {
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        margin-top: 15px;
      }
      button:hover {
        background-color: #45a049;
      }
      pre {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
      }
      #userList,
      #userDetails,
      #createResult,
      #updateResult,
      #deleteResult {
        margin-top: 15px;
      }
      .avatar-preview {
        max-width: 150px;
        max-height: 150px;
        margin-top: 10px;
        border: 1px solid #ddd;
      }
    </style>
  </head>
  <body>
    <h1>User API Test</h1>

    <div class="section">
      <h2>Get All Users</h2>
      <button id="getAllUsers">Get All Users</button>
      <div id="userList"></div>
    </div>

    <div class="section">
      <h2>Get User by ID</h2>
      <form id="getUserForm">
        <label for="getUserId">User ID:</label>
        <input type="number" id="getUserId" required />
        <button type="submit">Get User</button>
      </form>
      <div id="userDetails"></div>
    </div>

    <div class="section">
      <h2>Create User</h2>
      <form id="createUserForm" enctype="multipart/form-data">
        <label for="createEmail">Email:</label>
        <input type="email" id="createEmail" required />

        <label for="createName">Name:</label>
        <input type="text" id="createName" />

        <label for="createHomeAddr">Home Address:</label>
        <input type="text" id="createHomeAddr" />

        <label for="createAvatar">Avatar:</label>
        <input type="file" id="createAvatar" accept="image/*" />
        <img
          id="createAvatarPreview"
          class="avatar-preview"
          style="display: none"
        />

        <button type="submit">Create User</button>
      </form>
      <div id="createResult"></div>
    </div>

    <div class="section">
      <h2>Update User</h2>
      <form id="updateUserForm" enctype="multipart/form-data">
        <label for="updateUserId">User ID:</label>
        <input type="number" id="updateUserId" required />

        <label for="updateEmail">Email:</label>
        <input type="email" id="updateEmail" />

        <label for="updateName">Name:</label>
        <input type="text" id="updateName" />

        <label for="updateHomeAddr">Home Address:</label>
        <input type="text" id="updateHomeAddr" />

        <label for="updateAvatar">Avatar:</label>
        <input type="file" id="updateAvatar" accept="image/*" />
        <img
          id="updateAvatarPreview"
          class="avatar-preview"
          style="display: none"
        />

        <button type="submit">Update User</button>
      </form>
      <div id="updateResult"></div>
    </div>

    <div class="section">
      <h2>Delete User</h2>
      <form id="deleteUserForm">
        <label for="deleteUserId">User ID:</label>
        <input type="number" id="deleteUserId" required />
        <button type="submit">Delete User</button>
      </form>
      <div id="deleteResult"></div>
    </div>

    <script>
      // Helper function to format JSON
      function formatJSON(json) {
        return JSON.stringify(json, null, 2);
      }

      // Preview image before upload
      document
        .getElementById("createAvatar")
        .addEventListener("change", function (e) {
          const preview = document.getElementById("createAvatarPreview");
          if (e.target.files.length > 0) {
            preview.src = URL.createObjectURL(e.target.files[0]);
            preview.style.display = "block";
          }
        });

      document
        .getElementById("updateAvatar")
        .addEventListener("change", function (e) {
          const preview = document.getElementById("updateAvatarPreview");
          if (e.target.files.length > 0) {
            preview.src = URL.createObjectURL(e.target.files[0]);
            preview.style.display = "block";
          }
        });

      // Get all users
      document
        .getElementById("getAllUsers")
        .addEventListener("click", async () => {
          try {
            const response = await fetch("/api/users");
            const users = await response.json();
            document.getElementById("userList").innerHTML =
              `<pre>${formatJSON(users)}</pre>`;
          } catch (error) {
            document.getElementById("userList").innerHTML =
              `<p>Error: ${error.message}</p>`;
          }
        });

      // Get user by ID
      document
        .getElementById("getUserForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const userId = document.getElementById("getUserId").value;
          try {
            const response = await fetch(`/api/users/${userId}`);
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const user = await response.json();

            let userHTML = `<pre>${formatJSON(user)}</pre>`;
            if (user.avatar) {
              userHTML += `<img src="${user.avatar}" alt="User avatar" class="avatar-preview">`;
            }

            document.getElementById("userDetails").innerHTML = userHTML;
          } catch (error) {
            document.getElementById("userDetails").innerHTML =
              `<p>Error: ${error.message}</p>`;
          }
        });

      // Create user
      document
        .getElementById("createUserForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData();

          formData.append(
            "email",
            document.getElementById("createEmail").value,
          );
          formData.append("name", document.getElementById("createName").value);
          formData.append(
            "homeAddr",
            document.getElementById("createHomeAddr").value,
          );

          const avatarFile = document.getElementById("createAvatar").files[0];
          if (avatarFile) {
            formData.append("avatar", avatarFile);
          }

          try {
            const response = await fetch("/api/users", {
              method: "POST",
              body: formData,
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(
                errorData.error || `HTTP error! status: ${response.status}`,
              );
            }

            const result = await response.json();

            let resultHTML = `<p>User created successfully!</p><pre>${formatJSON(result)}</pre>`;
            if (result.avatar) {
              resultHTML += `<img src="${result.avatar}" alt="User avatar" class="avatar-preview">`;
            }

            document.getElementById("createResult").innerHTML = resultHTML;
            document.getElementById("createUserForm").reset();
            document.getElementById("createAvatarPreview").style.display =
              "none";
          } catch (error) {
            document.getElementById("createResult").innerHTML =
              `<p>Error: ${error.message}</p>`;
          }
        });

      // Update user
      document
        .getElementById("updateUserForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const userId = document.getElementById("updateUserId").value;
          const formData = new FormData();

          const email = document.getElementById("updateEmail").value;
          const name = document.getElementById("updateName").value;
          const homeAddr = document.getElementById("updateHomeAddr").value;

          if (email) formData.append("email", email);
          if (name) formData.append("name", name);
          if (homeAddr) formData.append("homeAddr", homeAddr);

          const avatarFile = document.getElementById("updateAvatar").files[0];
          if (avatarFile) {
            formData.append("avatar", avatarFile);
          }

          try {
            const response = await fetch(`/api/users/${userId}`, {
              method: "PUT",
              body: formData,
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(
                errorData.error || `HTTP error! status: ${response.status}`,
              );
            }

            const result = await response.json();

            let resultHTML = `<p>User updated successfully!</p><pre>${formatJSON(result)}</pre>`;
            if (result.avatar) {
              resultHTML += `<img src="${result.avatar}" alt="User avatar" class="avatar-preview">`;
            }

            document.getElementById("updateResult").innerHTML = resultHTML;
            document.getElementById("updateUserForm").reset();
            document.getElementById("updateAvatarPreview").style.display =
              "none";
          } catch (error) {
            document.getElementById("updateResult").innerHTML =
              `<p>Error: ${error.message}</p>`;
          }
        });

      // Delete user
      document
        .getElementById("deleteUserForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const userId = document.getElementById("deleteUserId").value;

          try {
            const response = await fetch(`/api/users/${userId}`, {
              method: "DELETE",
            });

            if (!response.ok && response.status !== 204) {
              const errorData = await response.json();
              throw new Error(
                errorData.error || `HTTP error! status: ${response.status}`,
              );
            }

            document.getElementById("deleteResult").innerHTML =
              `<p>User with ID ${userId} deleted successfully!</p>`;
            document.getElementById("deleteUserForm").reset();
          } catch (error) {
            document.getElementById("deleteResult").innerHTML =
              `<p>Error: ${error.message}</p>`;
          }
        });
    </script>
  </body>
</html>
