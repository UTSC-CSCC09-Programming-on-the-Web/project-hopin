# 🛡️ HopIn Backend Security Test Suite

DISCLAIMER: All test scripts were generated by COPILOT

A comprehensive security testing framework specifically designed to validate the security requirements for the HopIn backend, with special focus on subscription/payment security as required for the course project.

## 🎯 Overview

This test suite validates all critical security aspects required for the project:

- ✅ **Authentication Security** (OAuth 2.0 & Custom Login)
- ✅ **Subscription Enforcement** (Payment requirement before access)
- ✅ **Payment Security** (Stripe integration security)
- ✅ **Authorization Controls** (Access control & privilege escalation)
- ✅ **Rate Limiting & DDoS Protection**
- ✅ **Input Validation & Injection Prevention**
- ✅ **Session Management & Token Security**

## 🚀 Quick Start

### Prerequisites

1. **Backend server running** on `http://localhost:8080`
2. **Database accessible** (PostgreSQL with Prisma)
3. **Redis server running** (for rate limiting)
4. **Node.js 18+** installed

### Installation

```bash
cd backend/tests/security
npm install
```

### Running Tests

```bash
# Run all security tests
npm run test:security

# Run individual test suites
npm run test:auth           # Authentication tests
npm run test:subscription   # Subscription/payment tests
npm run test:ratelimit     # Rate limiting tests

# Test against different environments
npm run test:dev           # Local development
npm run test:prod          # Production (set URL in script)
```

## 📊 Test Coverage

### 1. Authentication Security Tests

- **SQL Injection Protection** 🔴 Critical
- **Brute Force Protection** 🔴 Critical
- **JWT Token Security** 🔴 Critical
- **Password Strength Enforcement** 🔴 Critical
- **Email Validation**
- **Session Fixation Protection**

### 2. Subscription Security Tests (Payment Requirements)

- **Access Without Subscription** 🔴 Critical
- **Subscription Status Manipulation** 🔴 Critical
- **Payment Bypass Prevention** 🔴 Critical
- **Subscription Validation**
- **Cancelled Subscription Handling** 🔴 Critical
- **Failed Payment Handling** 🔴 Critical
- **Stripe Checkout Security**
- **Webhook Signature Verification** 🔴 Critical

### 3. Authorization & Access Control Tests

- **Unauthorized Access Protection** 🔴 Critical
- **Privilege Escalation Prevention** 🔴 Critical
- **Cross-User Access Protection** 🔴 Critical
- **Admin Endpoint Protection**

### 4. Input Validation Tests

- **XSS Prevention** 🔴 Critical
- **Command Injection Prevention** 🔴 Critical
- **Path Traversal Prevention** 🔴 Critical
- **NoSQL Injection Prevention**
- **XML Injection Prevention**

### 5. Rate Limiting & DDoS Protection

- **Login Rate Limiting** 🔴 Critical
- **API Rate Limiting** 🔴 Critical
- **Progressive Rate Limiting**
- **High Volume Request Protection**
- **Rate Limit Bypass Prevention**

### 6. Session & Token Management

- **Token Expiry Handling**
- **Token Blacklisting** 🔴 Critical
- **Concurrent Session Management**

## 📋 Payment Security Requirements

The test suite specifically validates the course requirements:

### ✅ Subscription Before Access

- Users without subscriptions cannot access protected features
- Proper redirect to payment page
- Subscription status enforcement

### ✅ Payment Scenarios

- **No subscription** → Blocked access, redirect to payment
- **Cancelled subscription** → Blocked access, redirect to payment
- **Failed payment** → Blocked access, redirect to payment
- **Active subscription** → Access granted

### ✅ Stripe Integration Security

- Webhook signature verification
- Payment plan validation
- Checkout session security
- Customer portal access control

## 📈 Report Generation

After running tests, comprehensive reports are generated in `./security-reports/`:

- **`security-assessment.html`** - Interactive HTML report
- **`security-assessment.json`** - Machine-readable results
- **`security-assessment.md`** - Markdown summary

## 🔧 Configuration

### Environment Variables

```bash
# Test target (default: http://localhost:8080)
export TEST_BASE_URL=http://localhost:8080

# Frontend URL for integration tests
export FRONTEND_URL=http://localhost:3000
```

### Test Customization

Modify test parameters in each test file:

```javascript
const TEST_CONFIG = {
  timeout: 30000, // Request timeout
  maxRetries: 3, // Retry attempts
  delayBetweenTests: 100, // Delay between tests
};
```

## 🎯 Understanding Results

### Success Criteria

- **90%+ Success Rate**: Excellent security posture
- **80-89% Success Rate**: Good security with minor improvements needed
- **70-79% Success Rate**: Adequate security with improvements recommended
- **<70% Success Rate**: Significant security issues requiring attention

### Critical Issues (🔴)

Any test marked as "Critical" that fails indicates a severe security vulnerability that could:

- Allow unauthorized access to the application
- Bypass payment requirements (violating course requirements)
- Enable data breaches or system compromise
- Make the system vulnerable to automated attacks

### Payment Requirement Validation

For the course automarking, ensure these tests pass:

- ✅ No subscription access blocked
- ✅ Cancelled subscription access blocked
- ✅ Failed payment access blocked
- ✅ Subscription status API works correctly
- ✅ Payment page accessible
- ✅ Stripe integration secure

## 🐛 Troubleshooting

### Common Issues

**1. Connection Refused**

```bash
Error: fetch failed - connection refused
```

**Solution**: Ensure backend server is running on the correct port

**2. Rate Limiting False Positives**

```bash
Many tests failing with 429 status
```

**Solution**: Clear Redis cache or wait for rate limits to reset

**3. Database Connection Issues**

```bash
Prisma connection errors
```

**Solution**: Verify database is running and accessible

**4. Missing Dependencies**

```bash
Module not found errors
```

**Solution**: Run `npm install` in the security test directory

### Reset Test Environment

```bash
# Clear Redis rate limiting data
redis-cli FLUSHDB

# Reset test database (if using separate test DB)
npm run db:reset

# Wait for rate limits to naturally expire
sleep 300
```

## 🔍 Test Development

### Adding New Tests

1. **Choose appropriate test suite** (`security-tests.js`, `subscription-security-tests.js`, etc.)
2. **Follow naming convention**: `testFeatureSecurity()`
3. **Use logging helpers**: `logTest(testName, status, severity, details)`
4. **Mark critical tests**: Use `'critical'` severity for security-breaking issues

### Example Test Structure

```javascript
async function testNewSecurityFeature() {
  // Test setup
  const testData = {
    /* setup data */
  };

  // Execute test
  const response = await makeRequest("/api/endpoint", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(testData),
  });

  // Validate results
  const isSecure = response.status === 403; // or appropriate check

  // Log results
  logTest("New Security Feature", isSecure ? "PASS" : "FAIL", "critical");
}
```

## 📚 Security Best Practices Validated

This test suite validates implementation of:

- **OWASP Top 10** security vulnerabilities
- **JWT security best practices**
- **Rate limiting strategies**
- **Input validation techniques**
- **Payment security standards**
- **Session management security**
- **API security principles**

## 🎓 Course Requirement Mapping

### Authentication Requirement ✅

- OAuth 2.0 support tested
- Custom login system validated
- Password security enforced

### Payment Requirement ✅

- Subscription before access enforced
- Stripe Checkout integration secure
- All subscription scenarios handled:
  - No subscription → Payment page
  - Cancelled → Payment page
  - Failed payment → Payment page
  - Active → Access granted

### Security Requirement ✅

- Login system security validated
- Payment system security tested
- User data security verified

## 📞 Support

For issues with the security test suite:

1. Check the troubleshooting section
2. Review test logs for specific failures
3. Verify backend configuration
4. Check environment setup

---

**⚠️ Important**: These tests are designed to identify security vulnerabilities. Address all critical issues before production deployment to ensure the security and integrity of your application.

**🎯 Course Note**: This test suite specifically validates the payment security requirements for course automarking. Ensure all subscription-related tests pass to meet project requirements.
